<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">


    <script>
        //////////
        // ToDo //
        // negativer Wert Eingabe
        // leerzeichen und sonderzeichen mit code in den value (&xyz)
        // tastatureingabe


        let allowAppend = true // werden Eingaben angehängt oder überschrieben?
        let allowOperator = false // Operatoren als Eingabe Sperren
        let allowParenthesisOpen = true; allowParenthesisClose = false // Klammern öffnen nur mit vorherigen Operator
        let countOpen = 0; countClose = 0; // Klammern werden beim berechnen gecheckt
        let countComa = 0; // nur ein Komma pro Zahl


        function appendItem(itemValue) {

            let item = document.getElementById("idScreen").innerHTML
            document.getElementById("idMessage").innerHTML = "" // clear Fehlermeldung

            if (allowAppend) {
                if (item.endsWith(')')) {
                    alert("Bitte geben Sie nach der geschlossenen Klammer einen Operator wie + _ - _ * _ / ein!")
                } else {
                    document.getElementById("idScreen").innerHTML += itemValue
                    console.log("open: " + countOpen + "-- close: " + countClose) // später entfernen
                }
            }
            else {
                document.getElementById("idScreen").innerHTML = itemValue
                allowAppend = true
                console.log("open: " + countOpen + "-- close: " + countClose) // später entfernen

            }
        }

        function appendOperator(operatorValue) {
            item = document.getElementById("idScreen").innerHTML
            document.getElementById("idMessage").innerHTML = "" // clear Fehlermeldung


            // verhindert die Eingabe wenn das letzte Zeichen:
            // - leer; Ergebnis aus vorh. Berechnung; Operator; offene Klammer
            if (item.endsWith(" " || allowAppend == false) || item.endsWith('+') || item.endsWith('-') || item.endsWith('*') || item.endsWith('/') || item.endsWith('.') || item.endsWith('(')) {
                //tue nichts
            } else {
                allowAppend = true;
                document.getElementById("idScreen").innerHTML += operatorValue;
            }
        }

        //////////////
        // Klammern //

        function appendParenthesis(parenthesis) {
            let item = document.getElementById("idScreen").innerHTML
            // Prüfen ob Klammer an dieser Stelle mathematisch erlaubt ist
            if (
                ((item.endsWith(" ") || item.endsWith("(")) && parenthesis == "(" && !item.endsWith("."))
                || (!item.endsWith(" ") && parenthesis == ")" && !item.endsWith(".") && (countOpen > countClose))
            ) {
                document.getElementById("idScreen").innerHTML += parenthesis // Klammer hinzufügen
                // counter für Klammern
                if (parenthesis == "(") {
                    countOpen += 1
                } else { countClose += 1 }

                // den counter in der HTML aktualisierenS
                document.getElementById("idCounterParenthesis").innerHTML = countOpen + " -- " + countClose
            }
            else {
                document.getElementById("idMessage").innerHTML = "Hier darf keine Klammer gesetzt werden. <br><br>Ein Klammer darf nicht direkt nach einem Rechenoperator wie '+' oder '-' geschlossen oder ohne vorhergehenden Operator geöffnet werden. Außerdem darf sie nicht direkt vor oder nach einem Komma stehen <br><br> Beachte auch, dass du nicht mehr Klammern schließen als öffnen kannst."
            }

            console.log("open: " + countOpen + "-- close: " + countClose) // später entfernen
        }





        // Komma-Besonderheiten
        //ToDo: mehrere Kommas werden verhindert - allerdings auch in weiteren Zaheln
        function appendComa(itemValue) {
            let item = document.getElementById("idScreen").innerHTML
            if (item == " " || allowAppend == false) {
                // bei leerem Feld oder vorheriger "=" Taste wird ein "0." erzeugt            
                document.getElementById("idScreen").innerHTML = 0 + itemValue

            } else if (item.includes(".")) { // zweites Komma verhindern              
            } else {
                document.getElementById("idScreen").innerHTML += itemValue
            }
        }


        ///////////////
        // Berechnen //
        function calculate() {
            document.getElementById("idMessage").innerHTML = "" // clear Fehlermeldung

            if (countOpen == countClose) { // wurden genausoviele Klammern geschlossen wie geöffnet?
                let result = document.getElementById("idScreen").innerHTML
                result = eval(result)
                document.getElementById("idScreen").innerHTML = result
                allowAppend = false
                allowParenthesisClose = false
                allowParenthesisOpen = true
                countOpen = 0;
                countClose = 0;
            } else {
                document.getElementById("idMessage").innerHTML = ("Klammern nicht zulässig geschlossen")
            }
        }


        ////////////
        // Delete //

        function deleteItem() {
            let item = document.getElementById("idScreen").innerHTML


            if (item.endsWith(" ")) {
                document.getElementById("idScreen").innerHTML = item.slice(0, -3)
            } else {
                document.getElementById("idScreen").innerHTML = item.slice(0, -1)
            }
            // counter der Klammern berücksichtigen
            console.log(countOpen)
            if (item.endsWith("(")) {
                countOpen -= 1;
                document.getElementById("idCounterParenthesis").innerHTML = countOpen
            } else if (item.endsWith(")")) { countClose -= 1 }

            document.getElementById("idMessage").innerHTML = "" // clear Fehlermeldung
            document.getElementById("idCounterParenthesis").innerHTML = countOpen + " -- " + countClose
        }


    </script>

</head>

<body>
    <!-- Leerzeichen beachten // &nbsp; führt zu einer fehlerhaften Kalkulation -->
    <div id="idScreen"> </div> 

    <table>
        <tr>
            <td>MR</td>
            <td onclick="appendParenthesis('(')">(</td>
            <td onclick="appendParenthesis(')')">)</td>
            <td></td>
        </tr>
        <tr>
            </td>
            <td onclick="deleteItem()">DEL</td>
            <td onclick="appendOperator(' / ')">/</td>
            <td onclick="appendOperator(' * ')">*</td>
            <td onclick="appendOperator(' - ')">-</td>
        </tr>
        <tr>
            <td onclick="appendItem(7)">7</td>
            <td onclick="appendItem(8)">8</td>
            <td onclick="appendItem(9)">9</td>
            <td onclick="appendOperator(' + ')" rowspan="2">+</td>
        </tr>
        <tr>
            <td onclick="appendItem(4)">4</td>
            <td onclick="appendItem(5)">5</td>
            <td onclick="appendItem(6)">6</td>
        </tr>
        <tr>
            <td onclick="appendItem(1)">1</td>
            <td onclick="appendItem(2)">2</td>
            <td onclick="appendItem(3)">3</td>
            <td rowspan="2" onclick="calculate()">=</td>
        </tr>
        <tr>
            <td onclick="appendItem(0)" colspan="2">0</td>
            <td onclick="appendComa('.')">,</td>
        </tr>
    </table>
    <div id="idMessage"></div>
    <div id="idCounterParenthesis"></div>


    <script>
        document.getElementById("idCounterParenthesis").innerHTML = countOpen + " -- " + countClose
    </script>

</body>

</html>